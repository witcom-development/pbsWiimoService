<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
<mapper namespace="org.fincl.miss.server.scheduler.job.guest.GuestRemoveInfoMapper">
    <select id="chkGuestVoucherStataus" resultType="java.util.HashMap">
    <![CDATA[  
		SELECT CANCLE.VOUCHER_SEQ, CANCLE.CANCLE_SEQ, VOUCHER.PAYMENT_SEQ, PAY.PAYMENT_CONFM_NO, DATE_FORMAT(PAY.PAYMENT_DTTM, '%y%m%d') AS PAY_DTTM, PAY.PAYMENT_CONFM_NO, PAY.TOT_AMT 
			FROM TB_SVC_RENT_CANCLE CANCLE, TB_SVC_VOUCHER VOUCHER, TB_SVC_PAYMENT PAY
			WHERE CANCLE.REFUND_YN = 'N' AND CANCLE.RENT_CLS_CD IN ('RCC_003','RCC_004')
			AND CANCLE.VOUCHER_SEQ = VOUCHER.VOUCHER_SEQ
			AND PAY.PAYMENT_SEQ = VOUCHER.PAYMENT_SEQ
			AND VOUCHER.VOUCHER_USE_YN = 'N'
			AND CANCLE.RENT_DTTM <= DATE_ADD(NOW(), INTERVAL -1 HOUR)
    ]]>      
    </select>
    
    
    <select id="chkRentInvalidReturnOver" resultType="java.util.HashMap">
    <![CDATA[  
		SELECT *,
			TRUNCATE(((TIMESTAMPDIFF(SECOND, RENT_DTTM,(IFNULL(END_DTTM, NOW()))))/60),0) USE_MI,
			TIMESTAMPDIFF(second, (IFNULL(END_DTTM, NOW())), NOW()) REQ_SEC
			FROM TB_SVC_RENT
			WHERE RENT_YN = 'Y' AND END_DTTM IS NOT NULL
    ]]>      
    </select>
  
    <update id="setCancelInfo" parameterType="String">
        UPDATE TB_SVC_RENT_CANCLE
           SET REFUND_YN = 'Y'                         
              WHERE CANCLE_SEQ = #{cancelSeq} 
    </update>
    
    <update id="addRefundHist" parameterType="String">
        UPDATE TB_SVC_PAYMENT
           SET PAYMENT_STUS_CD  ='BIS_003' 
              ,CANCEL_DTTM = NOW()
              ,CANCEL_REASON_DESC ='보증금 환불'
              ,CANCEL_ADMIN_ID = 'AUTO'
         WHERE PAYMENT_SEQ = #{paymentSeq}  
    </update>
    
    <update id="addRefundHistFail" parameterType="String">
        UPDATE TB_SVC_PAYMENT
           SET PAYMENT_STUS_CD  ='BIS_004' 
         WHERE PAYMENT_SEQ = #{paymentSeq}  
    </update>
    
    <delete id="setVoucherUseComplete" parameterType="String">
        DELETE FROM TB_SVC_VOUCHER WHERE VOUCHER_SEQ = #{voucherSeq}                                                                                           
    </delete>
    
    
</mapper>